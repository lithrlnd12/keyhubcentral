const fs = require('fs');
const path = require('path');
const admin = require('firebase-admin');

// Manually parse .env.local to extract GOOGLE_SERVICE_ACCOUNT_KEY
function loadEnvKey() {
  const envPath = path.join(__dirname, '..', '.env.local');
  const content = fs.readFileSync(envPath, 'utf8');
  const match = content.match(/^GOOGLE_SERVICE_ACCOUNT_KEY="([\s\S]*?)"\s*$/m);
  if (!match) throw new Error('GOOGLE_SERVICE_ACCOUNT_KEY not found in .env.local');
  return JSON.parse(match[1]);
}

const serviceAccount = loadEnvKey();

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  projectId: 'key-hub-central',
});

const PENTEST_PASSWORD = 'PentestKH2026!';

const PENTEST_USERS = [
  { email: 'pentest-owner@keyhubcentral.com', displayName: 'Pentest Owner', role: 'owner' },
  { email: 'pentest-admin@keyhubcentral.com', displayName: 'Pentest Admin', role: 'admin' },
  { email: 'pentest-salesrep@keyhubcentral.com', displayName: 'Pentest Sales Rep', role: 'sales_rep' },
  { email: 'pentest-contractor@keyhubcentral.com', displayName: 'Pentest Contractor', role: 'contractor' },
  { email: 'pentest-pm@keyhubcentral.com', displayName: 'Pentest PM', role: 'pm' },
  { email: 'pentest-subscriber@keyhubcentral.com', displayName: 'Pentest Subscriber', role: 'subscriber' },
  { email: 'pentest-partner@keyhubcentral.com', displayName: 'Pentest Partner', role: 'partner' },
  { email: 'pentest-pending@keyhubcentral.com', displayName: 'Pentest Pending', role: 'pending' },
];

async function createPentestUsers() {
  console.log('Creating pentest users...\n');

  for (const u of PENTEST_USERS) {
    try {
      let userRecord;

      try {
        userRecord = await admin.auth().getUserByEmail(u.email);
        // Reset password and display name in case they were created manually with different values
        await admin.auth().updateUser(userRecord.uid, {
          password: PENTEST_PASSWORD,
          displayName: u.displayName,
          emailVerified: true,
        });
        console.log(`✓ ${u.email} already exists — password reset (uid: ${userRecord.uid})`);
      } catch (error) {
        if (error.code === 'auth/user-not-found') {
          userRecord = await admin.auth().createUser({
            email: u.email,
            password: PENTEST_PASSWORD,
            displayName: u.displayName,
            emailVerified: true,
          });
          console.log(`✓ Created ${u.email} (uid: ${userRecord.uid})`);
        } else {
          throw error;
        }
      }

      await admin.firestore().collection('users').doc(userRecord.uid).set({
        uid: userRecord.uid,
        email: u.email,
        displayName: u.displayName,
        phone: null,
        role: u.role,
        status: u.role === 'pending' ? 'pending' : 'active',
        requestedRole: null,
        baseZipCode: null,
        baseCoordinates: null,
        partnerId: u.role === 'partner' ? 'pentest-partner-001' : null,
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
        approvedAt: u.role !== 'pending' ? admin.firestore.FieldValue.serverTimestamp() : null,
        approvedBy: u.role !== 'pending' ? 'pentest-seed' : null,
      }, { merge: true });

    } catch (error) {
      console.error(`✗ Error with ${u.email}:`, error.message);
    }
  }

  // Create a test partner company for the partner account
  try {
    await admin.firestore().collection('partners').doc('pentest-partner-001').set({
      name: 'Pentest Partner Company',
      email: 'pentest-partner@keyhubcentral.com',
      phone: '555-000-0000',
      address: { street: '1 Test Ave', city: 'Oklahoma City', state: 'OK', zip: '73101' },
      status: 'active',
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
    }, { merge: true });
    console.log('\n✓ Created pentest partner company');
  } catch (error) {
    console.error('✗ Error creating pentest partner:', error.message);
  }

  console.log(`\n✅ Done! All pentest users created with password: ${PENTEST_PASSWORD}`);
  process.exit(0);
}

createPentestUsers().catch(console.error);
