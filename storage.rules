rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isValidFileType(contentType) {
      return contentType.matches('image/.*') ||
             contentType.matches('application/pdf') ||
             contentType.matches('application/msword') ||
             contentType.matches('application/vnd.openxmlformats-officedocument.*');
    }

    function isUnderSizeLimit(size) {
      return size < 10 * 1024 * 1024; // 10MB limit
    }

    // Helper to check if user is admin (via custom claims)
    function isAdmin() {
      return request.auth.token.isAdmin == true;
    }

    // Helper to check if user is internal (via custom claims)
    function isInternal() {
      return request.auth.token.isInternal == true;
    }

    // Contractor documents (W-9, insurance, etc.)
    match /contractors/{userId}/documents/{document} {
      // Admins can read all, contractors can read their own
      allow read: if isAuthenticated() &&
        (isAdmin() || request.auth.uid == userId);

      // Admins can upload for any contractor, contractors can upload their own
      allow write: if isAuthenticated() &&
        (isAdmin() || request.auth.uid == userId) &&
        isValidFileType(request.resource.contentType) &&
        isUnderSizeLimit(request.resource.size);
    }

    // Job photos (before/after categories)
    match /jobs/{jobId}/photos/{category}/{photo} {
      // Internal users can view job photos
      allow read: if isAuthenticated() && isInternal();

      // Internal users can upload photos
      // Category must be 'before' or 'after'
      allow write: if isAuthenticated() &&
        isInternal() &&
        category in ['before', 'after'] &&
        request.resource.contentType.matches('image/.*') &&
        isUnderSizeLimit(request.resource.size);
    }

    // Job documents (contracts, agreements, etc.)
    match /jobs/{jobId}/documents/{document} {
      // Internal users can view job documents
      allow read: if isAuthenticated() && isInternal();

      // Internal users can upload documents (PDF, Word, images)
      allow write: if isAuthenticated() &&
        isInternal() &&
        isValidFileType(request.resource.contentType) &&
        isUnderSizeLimit(request.resource.size);
    }

    // Service ticket photos
    match /serviceTickets/{ticketId}/photos/{photo} {
      allow read: if isAuthenticated() && isInternal();

      allow write: if isAuthenticated() &&
        isInternal() &&
        request.resource.contentType.matches('image/.*') &&
        isUnderSizeLimit(request.resource.size);
    }

    // User profile photos
    match /users/{userId}/profile/{photo} {
      allow read: if isAuthenticated();

      allow write: if isAuthenticated() &&
        request.auth.uid == userId &&
        request.resource.contentType.matches('image/.*') &&
        request.resource.size < 5 * 1024 * 1024; // 5MB for profile pics
    }

    // Lead attachments (for event capture forms)
    match /lead-attachments/{fileName} {
      // Internal users can read (admins viewing leads)
      allow read: if isAuthenticated() && isInternal();

      // Only authenticated internal users can upload lead attachments
      allow write: if isAuthenticated() &&
        isInternal() &&
        isValidFileType(request.resource.contentType) &&
        request.resource.size < 5 * 1024 * 1024; // 5MB limit
    }

    // Receipt uploads (images and PDFs for inventory)
    match /receipts/{userId}/{fileName} {
      // Authenticated users can read receipts (needed for AI parsing)
      allow read: if isAuthenticated();

      // Users can upload their own receipts
      allow write: if isAuthenticated() &&
        request.auth.uid == userId &&
        isValidFileType(request.resource.contentType) &&
        isUnderSizeLimit(request.resource.size);
    }

    // Partner ticket photos (issue documentation)
    match /partnerTickets/{userId}/photos/{fileName} {
      allow read: if isAuthenticated() &&
        (isAdmin() || request.auth.uid == userId);

      allow write: if isAuthenticated() &&
        (isAdmin() || request.auth.uid == userId) &&
        request.resource.contentType.matches('image/.*') &&
        isUnderSizeLimit(request.resource.size);
    }

    // Partner work order PDFs (SWO uploads)
    match /partnerTickets/{userId}/workorders/{fileName} {
      // Uploading user or admins can read
      allow read: if isAuthenticated() &&
        (isAdmin() || request.auth.uid == userId);

      // Uploading user or admins can write
      allow write: if isAuthenticated() &&
        (isAdmin() || request.auth.uid == userId) &&
        request.resource.contentType == 'application/pdf' &&
        isUnderSizeLimit(request.resource.size);
    }

    // Contract signatures and PDFs
    match /jobs/{jobId}/contracts/{contractId}/{path=**} {
      // Internal users can view contract files
      allow read: if isAuthenticated() && isInternal();

      // Internal users can upload signatures and PDFs
      allow write: if isAuthenticated() &&
        isInternal() &&
        (request.resource.contentType.matches('image/.*') ||
         request.resource.contentType == 'application/pdf') &&
        isUnderSizeLimit(request.resource.size);
    }
  }
}
