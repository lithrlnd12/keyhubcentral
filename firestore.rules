rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner', 'admin'];
    }

    function isInternalUser() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner', 'admin', 'sales_rep', 'contractor', 'pm'];
    }

    function isActiveUser() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active';
    }

    function isOwnDocument(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isPartner() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'partner';
    }

    function isContractor() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'contractor';
    }

    function getUserPartnerId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partnerId;
    }

    // Users collection
    match /users/{userId} {
      // Anyone can create their own user document (signup)
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Internal users can read user profiles (needed for user lookups)
      allow read: if isOwnDocument(userId) || isInternalUser();

      // Only admins can update user status/role, users can update own profile fields
      allow update: if isAdmin() ||
        (isOwnDocument(userId) &&
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status', 'approvedAt', 'approvedBy']));

      // Only owner can delete users
      allow delete: if isOwner();

      // Integrations subcollection (Google Calendar, etc.)
      match /integrations/{integrationId} {
        // Users can only read/write their own integrations
        allow read, write: if isOwnDocument(userId);
      }
    }

    // Contractors collection
    match /contractors/{contractorId} {
      // Internal users can read all contractors (needed for job assignment, availability views)
      // Per PRD: Owner, Admin, PM can see all contractors
      allow read: if isInternalUser();

      // Admins can create/update, contractors can update their own (limited fields)
      allow create: if isAdmin();
      allow update: if isAdmin() ||
        (isActiveUser() && resource.data.userId == request.auth.uid &&
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['rating', 'status']));

      allow delete: if isOwner();

      // Availability subcollection
      match /availability/{dateId} {
        // Internal users can read availability (needed for scheduling)
        allow read: if isInternalUser();

        // Admins and the contractor themselves can manage availability
        allow create, update: if isAdmin() ||
          (isActiveUser() && get(/databases/$(database)/documents/contractors/$(contractorId)).data.userId == request.auth.uid);

        allow delete: if isAdmin() ||
          (isActiveUser() && get(/databases/$(database)/documents/contractors/$(contractorId)).data.userId == request.auth.uid);
      }
    }

    // Jobs collection
    match /jobs/{jobId} {
      // Internal users can read jobs (UI filters based on role)
      // This allows list queries to work; frontend controls what's displayed
      allow read: if isInternalUser();

      // Admins can create any job
      // Sales reps can create jobs where they are the sales rep
      allow create: if isAdmin() ||
        (isActiveUser() &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'sales_rep' &&
          request.resource.data.salesRepId == request.auth.uid);

      // Status updates based on role
      allow update: if isAdmin() ||
        (isActiveUser() && (
          // PM can update most fields
          resource.data.pmId == request.auth.uid ||
          // Sales rep can update their own jobs (status, crew, photos, etc.)
          // but cannot change salesRepId or pmId
          (resource.data.salesRepId == request.auth.uid &&
            !request.resource.data.diff(resource.data).affectedKeys().hasAny(['salesRepId', 'pmId'])) ||
          // Crew members (contractors) can update photos field only
          (request.auth.uid in resource.data.crewIds &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['photos', 'updatedAt']))
        ));

      allow delete: if isOwner();

      // Job communications subcollection
      match /communications/{commId} {
        // Internal users can read job communications
        allow read: if isInternalUser();

        allow create: if isActiveUser();
        allow update, delete: if isAdmin() || resource.data.userId == request.auth.uid;
      }
    }

    // Service Tickets collection
    match /serviceTickets/{ticketId} {
      // Internal users can read service tickets
      allow read: if isInternalUser();

      allow create: if isAdmin();
      allow update: if isAdmin() ||
        (isActiveUser() && resource.data.assignedTechId == request.auth.uid);
      allow delete: if isOwner();
    }

    // Leads collection
    match /leads/{leadId} {
      // Internal users can read leads (UI filters by assignment)
      allow read: if isInternalUser();

      // Allow public lead creation (for event QR code capture)
      // Validates that required fields are present and source is 'event'
      allow create: if isAdmin() ||
        (request.resource.data.source == 'event' &&
         request.resource.data.status == 'new' &&
         request.resource.data.customer.name != null &&
         request.resource.data.customer.name != '');

      allow update: if isAdmin() ||
        (isActiveUser() && resource.data.assignedTo == request.auth.uid);
      allow delete: if isOwner();
    }

    // Campaigns collection
    match /campaigns/{campaignId} {
      // Internal users can read campaigns (needed for overview stats)
      // Only admins can create/modify campaigns
      allow read: if isInternalUser();
      allow write: if isAdmin();
    }

    // Subscriptions collection
    match /subscriptions/{subscriptionId} {
      allow read: if isAdmin() ||
        (isActiveUser() && resource.data.userId == request.auth.uid);

      allow create, update: if isAdmin();
      allow delete: if isOwner();
    }

    // Invoices collection
    match /invoices/{invoiceId} {
      // Internal users can read all invoices
      // Contractors can also read their own invoices (where they are from or to)
      allow read: if isInternalUser() ||
        (isContractor() && isActiveUser() && (
          resource.data.from.contractorId == request.auth.uid ||
          resource.data.to.contractorId == request.auth.uid
        ));

      // Admins can create any invoice
      // Contractors can create invoices FROM themselves only
      allow create: if isAdmin() ||
        (isContractor() && isActiveUser() &&
          request.resource.data.from.entity == 'contractor' &&
          request.resource.data.from.contractorId == request.auth.uid);

      // Admins can update any invoice
      // Contractors can update their own draft invoices only
      allow update: if isAdmin() ||
        (isContractor() && isActiveUser() &&
          resource.data.from.contractorId == request.auth.uid &&
          resource.data.status == 'draft');

      allow delete: if isOwner();
    }

    // Partners collection - External partner companies
    match /partners/{partnerId} {
      // Admins can read all partners
      allow read: if isAdmin();

      // Partners can read their own partner record
      allow read: if isPartner() && getUserPartnerId() == partnerId;

      // Only admins can create/update partners
      allow create, update: if isAdmin();
      allow delete: if isOwner();
    }

    // Labor Requests collection - Partner work requests
    match /laborRequests/{requestId} {
      // Admins can read all labor requests
      allow read: if isAdmin();

      // Partners can read their own company's requests
      allow read: if isPartner() && resource.data.partnerId == getUserPartnerId();

      // Partners can create requests for their own company
      allow create: if isPartner() &&
        isActiveUser() &&
        request.resource.data.partnerId == getUserPartnerId() &&
        request.resource.data.status == 'new';

      // Only admins can update (assign, change status)
      allow update: if isAdmin();
      allow delete: if isOwner();
    }

    // Partner Service Tickets collection
    match /partnerServiceTickets/{ticketId} {
      // Admins can read all partner tickets
      allow read: if isAdmin();

      // Partners can read their own company's tickets
      allow read: if isPartner() && resource.data.partnerId == getUserPartnerId();

      // Partners can create tickets for their own company
      allow create: if isPartner() &&
        isActiveUser() &&
        request.resource.data.partnerId == getUserPartnerId() &&
        request.resource.data.status == 'new';

      // Only admins can update (assign, change status)
      allow update: if isAdmin();
      allow delete: if isOwner();
    }

    // ========================================
    // INVENTORY MANAGEMENT COLLECTIONS
    // ========================================

    // Inventory Items collection - Materials and tools tracked
    match /inventoryItems/{itemId} {
      // Internal users can read inventory items
      allow read: if isInternalUser();

      // Only admins can create/update/delete items
      allow create, update: if isAdmin();
      allow delete: if isOwner();
    }

    // Inventory Locations collection - Warehouses and contractor trucks
    match /inventoryLocations/{locationId} {
      // Internal users can read locations
      allow read: if isInternalUser();

      // Only admins can create/update/delete locations
      allow create, update: if isAdmin();
      allow delete: if isOwner();
    }

    // Inventory Stock collection - Current stock levels per location
    match /inventoryStock/{stockId} {
      // Internal users can read stock levels
      allow read: if isInternalUser();

      // Admins can update any stock
      allow create, update: if isAdmin();

      // Contractors can only update stock for their own truck location
      allow create, update: if isActiveUser() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'contractor' &&
        get(/databases/$(database)/documents/inventoryLocations/$(request.resource.data.locationId)).data.contractorId == request.auth.uid;

      allow delete: if isOwner();
    }

    // Inventory Counts collection - Count session records
    match /inventoryCounts/{countId} {
      // Internal users can read count history
      allow read: if isInternalUser();

      // Admins can create counts for any location
      allow create: if isAdmin();

      // Contractors can create counts for their own truck
      allow create: if isActiveUser() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'contractor' &&
        get(/databases/$(database)/documents/inventoryLocations/$(request.resource.data.locationId)).data.contractorId == request.auth.uid;

      // Only admins can update/delete counts
      allow update, delete: if isAdmin();
    }

    // Receipts collection - Uploaded receipts with parsed data
    match /receipts/{receiptId} {
      // Admins can read all receipts
      allow read: if isAdmin();

      // Users can read their own receipts
      allow read: if isActiveUser() && resource.data.uploadedBy == request.auth.uid;

      // Internal users can create receipts
      allow create: if isInternalUser() && isActiveUser();

      // Only admins can update receipts (verify, add to P&L)
      allow update: if isAdmin();

      // Users can update their own pending receipts (edit parsed data)
      allow update: if isActiveUser() &&
        resource.data.uploadedBy == request.auth.uid &&
        resource.data.status in ['pending', 'parsing', 'parsed'];

      allow delete: if isOwner();
    }

    // Expenses collection - Direct expenses from receipts for P&L
    match /expenses/{expenseId} {
      // Internal users can read expenses (needed for P&L)
      // Contractors can read their own expenses
      allow read: if isInternalUser() ||
        (isContractor() && isActiveUser() && resource.data.createdBy == request.auth.uid);

      // Admins can create/update expenses
      // Contractors can create expenses for themselves (from receipts)
      allow create: if isAdmin() ||
        (isContractor() && isActiveUser() &&
          request.resource.data.createdBy == request.auth.uid &&
          request.resource.data.entity == 'contractor');

      // Only admins can update expenses
      allow update: if isAdmin();

      // Only owner can delete expenses
      allow delete: if isOwner();
    }

    // ========================================
    // RATING REQUESTS COLLECTION
    // ========================================

    // Rating Requests collection - Customer rating surveys
    match /ratingRequests/{requestId} {
      // Public read access - token in URL provides security
      // The app validates the token matches before showing rating form
      allow read: if true;

      // Only Cloud Functions (admin SDK) can create rating requests
      // This happens automatically when job status changes to 'complete'
      allow create: if false;

      // Allow public updates for rating submission
      // Token validation happens in app code
      // Only allow updating rating-related fields
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['rating', 'comment', 'status', 'completedAt', 'reminderSentAt']);

      // No deletes allowed
      allow delete: if false;
    }
  }
}
