rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner', 'admin'];
    }

    function isInternalUser() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner', 'admin', 'sales_rep', 'contractor', 'pm'];
    }

    function isActiveUser() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active';
    }

    function isOwnDocument(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isPartner() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'partner';
    }

    function getUserPartnerId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partnerId;
    }

    // Users collection
    match /users/{userId} {
      // Anyone can create their own user document (signup)
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Internal users can read user profiles (needed for user lookups)
      allow read: if isOwnDocument(userId) || isInternalUser();

      // Only admins can update user status/role, users can update own profile fields
      allow update: if isAdmin() ||
        (isOwnDocument(userId) &&
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status', 'approvedAt', 'approvedBy']));

      // Only owner can delete users
      allow delete: if isOwner();

      // Integrations subcollection (Google Calendar, etc.)
      match /integrations/{integrationId} {
        // Users can only read/write their own integrations
        allow read, write: if isOwnDocument(userId);
      }
    }

    // Contractors collection
    match /contractors/{contractorId} {
      // Internal users can read all contractors (needed for job assignment, availability views)
      // Per PRD: Owner, Admin, PM can see all contractors
      allow read: if isInternalUser();

      // Admins can create/update, contractors can update their own (limited fields)
      allow create: if isAdmin();
      allow update: if isAdmin() ||
        (isActiveUser() && resource.data.userId == request.auth.uid &&
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['rating', 'status']));

      allow delete: if isOwner();

      // Availability subcollection
      match /availability/{dateId} {
        // Internal users can read availability (needed for scheduling)
        allow read: if isInternalUser();

        // Admins and the contractor themselves can manage availability
        allow create, update: if isAdmin() ||
          (isActiveUser() && get(/databases/$(database)/documents/contractors/$(contractorId)).data.userId == request.auth.uid);

        allow delete: if isAdmin() ||
          (isActiveUser() && get(/databases/$(database)/documents/contractors/$(contractorId)).data.userId == request.auth.uid);
      }
    }

    // Jobs collection
    match /jobs/{jobId} {
      // Internal users can read jobs (UI filters based on role)
      // This allows list queries to work; frontend controls what's displayed
      allow read: if isInternalUser();

      allow create: if isAdmin();

      // Status updates based on role
      allow update: if isAdmin() ||
        (isActiveUser() && (
          // PM can update most fields
          resource.data.pmId == request.auth.uid ||
          // Sales rep can only update lead -> sold
          (resource.data.salesRepId == request.auth.uid &&
            resource.data.status == 'lead' &&
            request.resource.data.status == 'sold')
        ));

      allow delete: if isOwner();

      // Job communications subcollection
      match /communications/{commId} {
        // Internal users can read job communications
        allow read: if isInternalUser();

        allow create: if isActiveUser();
        allow update, delete: if isAdmin() || resource.data.userId == request.auth.uid;
      }
    }

    // Service Tickets collection
    match /serviceTickets/{ticketId} {
      // Internal users can read service tickets
      allow read: if isInternalUser();

      allow create: if isAdmin();
      allow update: if isAdmin() ||
        (isActiveUser() && resource.data.assignedTechId == request.auth.uid);
      allow delete: if isOwner();
    }

    // Leads collection
    match /leads/{leadId} {
      // Internal users can read leads (UI filters by assignment)
      allow read: if isInternalUser();

      // Allow public lead creation (for event QR code capture)
      // Validates that required fields are present and source is 'event'
      allow create: if isAdmin() ||
        (request.resource.data.source == 'event' &&
         request.resource.data.status == 'new' &&
         request.resource.data.customer.name != null &&
         request.resource.data.customer.name != '');

      allow update: if isAdmin() ||
        (isActiveUser() && resource.data.assignedTo == request.auth.uid);
      allow delete: if isOwner();
    }

    // Campaigns collection
    match /campaigns/{campaignId} {
      // Internal users can read campaigns (needed for overview stats)
      // Only admins can create/modify campaigns
      allow read: if isInternalUser();
      allow write: if isAdmin();
    }

    // Subscriptions collection
    match /subscriptions/{subscriptionId} {
      allow read: if isAdmin() ||
        (isActiveUser() && resource.data.userId == request.auth.uid);

      allow create, update: if isAdmin();
      allow delete: if isOwner();
    }

    // Invoices collection
    match /invoices/{invoiceId} {
      // Internal users can read invoices (needed for earnings calculations)
      allow read: if isInternalUser();

      allow create, update: if isAdmin();
      allow delete: if isOwner();
    }

    // Partners collection - External partner companies
    match /partners/{partnerId} {
      // Admins can read all partners
      allow read: if isAdmin();

      // Partners can read their own partner record
      allow read: if isPartner() && getUserPartnerId() == partnerId;

      // Only admins can create/update partners
      allow create, update: if isAdmin();
      allow delete: if isOwner();
    }

    // Labor Requests collection - Partner work requests
    match /laborRequests/{requestId} {
      // Admins can read all labor requests
      allow read: if isAdmin();

      // Partners can read their own company's requests
      allow read: if isPartner() && resource.data.partnerId == getUserPartnerId();

      // Partners can create requests for their own company
      allow create: if isPartner() &&
        isActiveUser() &&
        request.resource.data.partnerId == getUserPartnerId() &&
        request.resource.data.status == 'new';

      // Only admins can update (assign, change status)
      allow update: if isAdmin();
      allow delete: if isOwner();
    }

    // Partner Service Tickets collection
    match /partnerServiceTickets/{ticketId} {
      // Admins can read all partner tickets
      allow read: if isAdmin();

      // Partners can read their own company's tickets
      allow read: if isPartner() && resource.data.partnerId == getUserPartnerId();

      // Partners can create tickets for their own company
      allow create: if isPartner() &&
        isActiveUser() &&
        request.resource.data.partnerId == getUserPartnerId() &&
        request.resource.data.status == 'new';

      // Only admins can update (assign, change status)
      allow update: if isAdmin();
      allow delete: if isOwner();
    }
  }
}
